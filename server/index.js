// ==========================================
// 1. IMPORT MODULES
// ==========================================
const express = require("express")
const http = require("http")
const { Server } = require("socket.io")
const path = require("path")

// ==========================================
// 2. à¸ªà¸£à¹‰à¸²à¸‡à¹à¸­à¸› Express à¹à¸¥à¸° Socket.IO
// ==========================================
const app = express()
const server = http.createServer(app)
const io = new Server(server)
const PORT = process.env.PORT || 3000

// ==========================================
// 3. à¹€à¸ªà¸´à¸£à¹Œà¸Ÿà¹„à¸Ÿà¸¥à¹Œà¸à¸±à¹ˆà¸‡ client (HTML, CSS, JS)
// ==========================================
// à¸—à¸¸à¸à¹„à¸Ÿà¸¥à¹Œà¹ƒà¸™à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ client à¸ˆà¸°à¸–à¸¹à¸à¹€à¸ªà¸´à¸£à¹Œà¸Ÿà¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
// à¹€à¸Šà¹ˆà¸™ client/index.html â†’ http://localhost:3000/index.html
app.use(express.static(path.join(__dirname, "../client")))

// ==========================================
// 4. à¸•à¸±à¸§à¹à¸›à¸£à¸«à¸¥à¸±à¸: à¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¹‰à¸­à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹ƒà¸™ memory
// ==========================================
// à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡ rooms:
// {
//   "ABCD": {
//       players: ["socketid1", "socketid2"]
//   },
//   "XYZ1": {
//       players: ["socketid9"]
//   }
// }
let rooms = {}

// ==========================================
// 5. à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ helper: broadcast à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸«à¹‰à¸­à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
// ==========================================
// à¸—à¸¸à¸à¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆà¸ªà¸£à¹‰à¸²à¸‡à¸«à¹‰à¸­à¸‡ / à¸¥à¸šà¸«à¹‰à¸­à¸‡ / à¸¡à¸µà¸„à¸™à¸­à¸­à¸
// à¹€à¸£à¸²à¸ˆà¸°à¸­à¸±à¸›à¹€à¸”à¸•à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸«à¹‰à¸­à¸‡à¹ƒà¸«à¹‰à¸—à¸¸à¸ client à¸—à¸µà¹ˆà¹€à¸›à¸´à¸” Room List à¸­à¸¢à¸¹à¹ˆ
function broadcastRooms() {
  const list = Object.keys(rooms).map((code) => ({
    code,
    players: rooms[code].players.length,
  }))
  io.emit("roomList", list)
}

// ==========================================
// 6. EVENT à¸«à¸¥à¸±à¸à¸‚à¸­à¸‡ Socket.IO
// ==========================================
io.on("connection", (socket) => {
  console.log("ðŸŸ¢ Connected:", socket.id)

  // ------------------------------------------
  // ðŸ§© à¸ªà¸£à¹‰à¸²à¸‡à¸«à¹‰à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ
  // ------------------------------------------
  socket.on("createRoom", () => {
    // à¸ªà¸£à¹‰à¸²à¸‡à¸£à¸«à¸±à¸ªà¸«à¹‰à¸­à¸‡ 4 à¸•à¸±à¸§ à¹€à¸Šà¹ˆà¸™ AB12
    const code = Math.random().toString(36).substring(2, 6).toUpperCase()

    // à¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸«à¹‰à¸­à¸‡à¹ƒà¸™ memory
    rooms[code] = { players: [socket.id] }

    // à¹ƒà¸«à¹‰ socket à¸™à¸µà¹‰à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡ (room à¸‚à¸­à¸‡ socket.io)
    socket.join(code)

    // à¹à¸ˆà¹‰à¸‡à¸à¸¥à¸±à¸šà¹„à¸›à¸¢à¸±à¸‡à¸œà¸¹à¹‰à¸ªà¸£à¹‰à¸²à¸‡à¸§à¹ˆà¸²à¸«à¹‰à¸­à¸‡à¸–à¸¹à¸à¸ªà¸£à¹‰à¸²à¸‡à¹à¸¥à¹‰à¸§
    socket.emit("roomCreated", code)
    console.log(`âœ… Room created: ${code}`)

    // à¸­à¸±à¸›à¹€à¸”à¸•à¸£à¸²à¸¢à¸à¸²à¸£à¸«à¹‰à¸­à¸‡à¹ƒà¸«à¹‰à¸—à¸¸à¸ client à¸—à¸µà¹ˆà¸”à¸¹ Room List
    broadcastRooms()
  })

  // ------------------------------------------
  // ðŸ“œ à¸‚à¸­à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸«à¹‰à¸­à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” (à¸«à¸™à¹‰à¸² Room List)
  // ------------------------------------------
  socket.on("getRooms", () => {
    const roomList = Object.keys(rooms).map((code) => ({
      code,
      players: rooms[code].players.length,
    }))
    socket.emit("roomList", roomList)
  })

  // ------------------------------------------
  // ðŸšª à¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡à¸—à¸µà¹ˆà¸¡à¸µà¸­à¸¢à¸¹à¹ˆà¹à¸¥à¹‰à¸§
  // ------------------------------------------
  socket.on("joinRoom", (code) => {
    console.log(`ðŸŸ¡ ${socket.id} wants to join ${code}`)

    // à¸•à¸£à¸§à¸ˆà¸§à¹ˆà¸²à¸«à¹‰à¸­à¸‡à¸¡à¸µà¸­à¸¢à¸¹à¹ˆà¹„à¸«à¸¡
    if (rooms[code]) {
      // à¸ˆà¸³à¸à¸±à¸”à¸ˆà¸³à¸™à¸§à¸™à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸ªà¸¹à¸‡à¸ªà¸¸à¸” à¹€à¸Šà¹ˆà¸™ 8 à¸„à¸™
      if (rooms[code].players.length >= 8) {
        socket.emit("error", "âš ï¸ Room is full!")
        return
      }

      // à¹€à¸žà¸´à¹ˆà¸¡à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸«à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¸«à¹‰à¸­à¸‡
      socket.join(code)
      rooms[code].players.push(socket.id)

      // à¸ªà¹ˆà¸‡ event à¸šà¸­à¸à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸™à¸µà¹‰à¸§à¹ˆà¸² join à¸ªà¸³à¹€à¸£à¹‡à¸ˆ
      socket.emit("joinedRoom", code)

      // à¹à¸ˆà¹‰à¸‡à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸„à¸™à¸­à¸·à¹ˆà¸™à¹ƒà¸™à¸«à¹‰à¸­à¸‡à¸§à¹ˆà¸²à¸¡à¸µà¸„à¸™à¹ƒà¸«à¸¡à¹ˆà¹€à¸‚à¹‰à¸²à¸¡à¸²
      io.to(code).emit("newPlayer", socket.id)

      // à¸­à¸±à¸›à¹€à¸”à¸•à¸£à¸²à¸¢à¸à¸²à¸£à¸«à¹‰à¸­à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
      broadcastRooms()
    } else {
      socket.emit("error", "âŒ Room not found!")
    }
  })

  // ------------------------------------------
  // ðŸ•¹ï¸ à¸£à¸±à¸šà¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§à¸ˆà¸²à¸à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸™à¸«à¹‰à¸­à¸‡
  // ------------------------------------------
  socket.on("move", (data) => {
    // à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸«à¹‰à¸­à¸‡à¸ˆà¸£à¸´à¸‡à¹„à¸«à¸¡
    const room = rooms[data.room]
    if (!room || !room.players.includes(socket.id)) return

    // à¸ªà¹ˆà¸‡à¸•à¸³à¹à¸«à¸™à¹ˆà¸‡à¸‚à¸­à¸‡ player à¸™à¸µà¹‰à¹ƒà¸«à¹‰à¸„à¸™à¸­à¸·à¹ˆà¸™à¹ƒà¸™à¸«à¹‰à¸­à¸‡
    socket.to(data.room).emit("playerMoved", {
      id: socket.id,
      player: data.player,
    })
  })

  // ------------------------------------------
  // âŒ à¹€à¸¡à¸·à¹ˆà¸­à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¸«à¸¥à¸¸à¸”à¸­à¸­à¸à¸ˆà¸²à¸à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ
  // ------------------------------------------
  socket.on("disconnect", () => {
    console.log("ðŸ”´ Disconnected:", socket.id)

    // à¸¥à¸š socket à¸™à¸µà¹‰à¸­à¸­à¸à¸ˆà¸²à¸à¸—à¸¸à¸à¸«à¹‰à¸­à¸‡à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ
    for (const code in rooms) {
      rooms[code].players = rooms[code].players.filter((id) => id !== socket.id)

      // à¸–à¹‰à¸²à¸«à¹‰à¸­à¸‡à¸™à¸µà¹‰à¹„à¸¡à¹ˆà¸¡à¸µà¸„à¸™à¹à¸¥à¹‰à¸§ â†’ à¸¥à¸šà¸«à¹‰à¸­à¸‡à¸—à¸´à¹‰à¸‡
      if (rooms[code].players.length === 0) {
        delete rooms[code]
        console.log(`ðŸ—‘ï¸ Room deleted: ${code}`)
      }
    }

    // à¸­à¸±à¸›à¹€à¸”à¸•à¸£à¸²à¸¢à¸à¸²à¸£à¸«à¹‰à¸­à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹ƒà¸«à¹‰à¸—à¸¸à¸ client
    broadcastRooms()
  })
})

socket.on("playerReady", ({ room, ready }) => {
  const r = rooms[room];
  if (!r) return;

  // à¹€à¸à¹‡à¸šà¸ªà¸–à¸²à¸™à¸° ready à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™à¹ƒà¸™ object (à¹€à¸žà¸´à¹ˆà¸¡ key â€œreadyâ€)
  if (!r.info) r.info = {}; // à¸ªà¸£à¹‰à¸²à¸‡ dict à¹„à¸§à¹‰à¹€à¸à¹‡à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸žà¸´à¹ˆà¸¡
  r.info[socket.id] = { ready };

  // à¸£à¸§à¸¡à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸žà¸£à¹‰à¸­à¸¡à¸ªà¸–à¸²à¸™à¸°
  const playerList = r.players.map(id => ({
    name: id.substring(0, 5),
    ready: r.info[id]?.ready || false,
  }));

  // broadcast à¹ƒà¸«à¹‰à¸—à¸¸à¸à¸„à¸™à¹ƒà¸™à¸«à¹‰à¸­à¸‡à¸£à¸¹à¹‰
  io.to(room).emit("updatePlayers", playerList);
});

socket.on("chatMessage", (data) => {
  io.to(data.room).emit("chatMessage", {
    sender: socket.id.substring(0, 5),
    text: data.text,
  });
});


// ==========================================
// 7. à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ
// ==========================================
server.listen(PORT, () => {
  console.log(`ðŸš€ Server running on port ${PORT}`)
})
// End of file