<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lobby</title>
  <style>
    body{
      margin:0;background:#0b1324;color:#E6E6FA;font-family:'Segoe UI',system-ui,sans-serif;
      overflow:hidden;height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;
    }
    canvas#bgCanvas{position:fixed;inset:0;z-index:-1}

    .back-btn{
      position:fixed;top:20px;left:20px;background:linear-gradient(135deg,#54f4a8,#25c07d);
      color:#0b1324;border:none;padding:10px 18px;border-radius:50px;font-weight:700;cursor:pointer;
      box-shadow:0 4px 10px #0007;transition:all .2s ease;
    }
    .back-btn:hover{transform:translateY(-2px)}

    .warning-box{
      position:fixed;top:20px;left:50%;transform:translateX(-50%);
      background:rgba(255,230,120,.15);border:1px solid rgba(255,220,80,.4);color:#fff9c4;font-weight:700;
      padding:10px 18px;border-radius:12px;box-shadow:0 6px 20px rgba(255,255,0,.15);
      backdrop-filter:blur(10px);opacity:0;pointer-events:none;transition:opacity .6s ease;z-index:5;
    }
    .warning-box.show{opacity:1}

    /* ‚úÖ ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ overlay ‡∏ö‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ï‡∏≠‡∏ô‡∏ã‡πà‡∏≠‡∏ô */
    .countdown-overlay{
      position:fixed;inset:0;display:flex;justify-content:center;align-items:center;
      background:rgba(0,0,0,.6);backdrop-filter:blur(8px);color:#fff;font-size:72px;font-weight:900;
      letter-spacing:2px;text-shadow:0 0 40px #00ffcc;opacity:0;transition:opacity .3s ease;z-index:10;
      pointer-events:none;
    }
    .countdown-overlay.show{opacity:1;pointer-events:auto;}

    .char-section{display:flex;align-items:center;justify-content:center;gap:20px;flex-direction:column}
    .char-box{position:relative;display:flex;align-items:center;justify-content:center;gap:18px}
    .char-btn{font-size:36px;background:none;border:none;color:#fff;cursor:pointer;transition:transform .1s}
    .char-btn:hover{transform:scale(1.2)}
    .char-img{width:clamp(180px,28vw,300px);height:clamp(180px,28vw,300px);object-fit:contain;image-rendering:pixelated;
      filter:drop-shadow(0 10px 20px rgba(0,0,0,.6));animation:bob 2.8s ease-in-out infinite}
    @keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .shadow{width:150px;height:32px;border-radius:50%;
      background:radial-gradient(ellipse at center,rgba(0,0,0,.45) 0%,rgba(0,0,0,0) 70%);margin-top:-14px;filter:blur(2px)}
    .ready-btn{background:linear-gradient(135deg,#E02F2F,#C04125);border:none;padding:12px 28px;border-radius:12px;color:#fff;
      font-weight:800;font-size:18px;cursor:pointer;margin-top:10px;box-shadow:0 8px 20px #0007;transition:transform .1s}
    .ready-btn:hover{transform:translateY(-2px)}
    .ready-char{animation:pulse .6s ease-in-out infinite alternate}
    @keyframes pulse{0%{transform:scale(1) translateY(0)}100%{transform:scale(1.05) translateY(-3px)}}

    .player-list{
      position:fixed;top:20px;right:20px;width:220px;background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:12px;box-shadow:0 8px 30px #0008;
      z-index:6; /* ‚¨Ü ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠ warning-box */
    }
    .player-list h3{margin:0 0 8px;font-size:16px;color:#8be9fd;text-align:center}
    .player-list ul{list-style:none;padding:0;margin:0;max-height:200px;overflow-y:auto}
    .player-list li{padding:4px 0;border-bottom:1px solid rgba(255,255,255,.1);font-size:14px;text-align:center}

    .chat-box{
      position:fixed;bottom:20px;right:20px;width:280px;background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:12px;display:flex;flex-direction:column;box-shadow:0 8px 30px #0008;
      z-index:6; pointer-events:auto; /* ‚¨Ü ‡∏î‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô */
    }
    .chat-messages{flex:1;overflow-y:auto;max-height:180px;font-size:14px}
    .chat-input{margin-top:8px;display:flex;gap:6px}
    .chat-input input{flex:1;padding:6px 8px;border-radius:8px;border:none;background:rgba(255,255,255,.15);color:white;outline:none}
    .chat-input button{padding:6px 10px;background:#54f4a8;border:none;border-radius:8px;color:#0b1324;cursor:pointer;font-weight:700}
  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>

  <div class="warning-box" id="warningBox">‚ö†Ô∏è ‡πÄ‡∏Å‡∏°‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏Å‡∏î Ready</div>
  <div class="countdown-overlay" id="countdownOverlay">3</div>

  <button class="back-btn" id="btnBack">‚¨Ö Leave</button>

  <div class="player-list">
    <h3>üë• Players</h3>
    <ul id="playerList">
      <li>YOU</li>
      <li>Guest_1</li>
      <li>Guest_2</li>
    </ul>
  </div>

  <div class="char-section">
    <h1>üéÆ Lobby</h1>
    <p>Room: <span id="roomName">My Room</span> | Code: <span id="roomCode">XXXX</span></p>

    <div class="char-box">
      <button class="char-btn" id="prevChar">‚¨Ö</button>
      <img id="charImage" class="char-img" src="./assets/Characters/mini_brown/idle_1.png" alt="Character">
      <button class="char-btn" id="nextChar">‚û°</button>
    </div>
    <div class="shadow"></div>
    <h3 id="charLabel">BROWN</h3>

    <button class="ready-btn" id="readyBtn">UNREADY ‚úñ</button>
  </div>

  <div class="chat-box">
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    // üì¶ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á
    const savedRoom = JSON.parse(localStorage.getItem('currentRoom') || '{}');
    document.getElementById("roomName").textContent = savedRoom.name || "My Room";
    document.getElementById("roomCode").textContent = savedRoom.code || "XXXX";

    // üåê Socket.IO
    const isLocal = location.hostname === "localhost" || location.hostname === "127.0.0.1";
    const socket = io(isLocal ? "http://localhost:3000" : "https://webgame-25n5.onrender.com", {
      transports:["websocket"], withCredentials:false
    });

// ===== Debug / Join room =====
socket.on("connect", () => {
  console.log("‚úÖ Connected:", socket.id);
  if (savedRoom?.code) {
    // ‚õ≥ ‡πÅ‡∏Å‡πâ: ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡πá‡∏≠‡∏ö‡πÄ‡∏à‡πá‡∏Å‡∏ï‡πå‡πÅ‡∏ó‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á
    socket.emit("joinRoom", {
      room: savedRoom.code,
      name: savedRoom.name || "YOU",
    });
  } else {
    console.warn("No room code. Chat disabled.");
  }
});

    // üåå ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
    const canvas = document.getElementById("bgCanvas");
    const ctx = canvas.getContext("2d");
    function drawBackground(){
      canvas.width = innerWidth; canvas.height = innerHeight;
      const g = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width*0.6);
      g.addColorStop(0,"#1e2130"); g.addColorStop(1,"#0b0d12");
      ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width,canvas.height);
      const starCount = Math.min(100, Math.floor((canvas.width*canvas.height)/8000));
      for(let i=0;i<starCount;i++){
        const x=Math.random()*canvas.width, y=Math.random()*canvas.height;
        ctx.fillStyle=`rgba(255,255,255,${Math.random()*0.5+0.3})`;
        ctx.beginPath(); ctx.arc(x,y,Math.random()*1.5+0.5,0,Math.PI*2); ctx.fill();
      }
    }
    drawBackground(); addEventListener('resize', drawBackground); setInterval(drawBackground,10000);

    // üë§ ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
    const characters=["mini_brown","mini_coral","mini_gray","mini_lavender","mini_mint","mini_pink","mini_sky_blue","mini_yellow"];
    let currentCharIndex=0, isReady=false;
    const img=document.getElementById("charImage"), label=document.getElementById("charLabel");
    function updateChar(){
      const f=characters[currentCharIndex];
      img.src=`./assets/Characters/${f}/idle_1.png`;
      label.textContent=f.replace("mini_","").toUpperCase();
      if (socket.connected) socket.emit("changeChar",{room:savedRoom.code,char:f});
    }
    const prev=document.getElementById("prevChar"), next=document.getElementById("nextChar");
    prev.onclick=()=>{ if(!isReady){ currentCharIndex=(currentCharIndex-1+characters.length)%characters.length; updateChar(); } };
    next.onclick=()=>{ if(!isReady){ currentCharIndex=(currentCharIndex+1)%characters.length; updateChar(); } };
    updateChar();

    // ‚ö†Ô∏è Warning & Countdown
    const warning=document.getElementById("warningBox");
    const overlay=document.getElementById("countdownOverlay");
    function showWarning(){
      warning.classList.add("show");
      clearTimeout(warning._t);
      warning._t=setTimeout(()=>warning.classList.remove("show"),4000);
    }
    function startCountdown(){
      let count=3;
      overlay.textContent=count;
      overlay.classList.add("show");
      const timer=setInterval(()=>{
        count--;
        overlay.textContent=count>0?count:"GO!";
        if(count<0){
          clearInterval(timer);
          overlay.classList.remove("show");
          window.location.href="game.html";
        }
      },1000);
    }

    // üü© READY
    const readyBtn=document.getElementById("readyBtn");
    readyBtn.onclick=()=>{
      isReady=!isReady;
      readyBtn.textContent=isReady?"READY ‚úî":"UNREADY ‚úñ";
      readyBtn.style.background=isReady?"linear-gradient(135deg,#77FF6B,#4AFF59)":"linear-gradient(135deg,#E02F2F,#C04125)";
      img.classList.toggle("ready-char",isReady);

      // ‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏≠‡∏ô Ready
      prev.disabled = next.disabled = isReady;
      prev.style.opacity = next.style.opacity = isReady ? 0.3 : 1;
      prev.style.cursor = next.style.cursor = isReady ? "not-allowed" : "pointer";

      showWarning();
      if (socket.connected) socket.emit("playerReady",{room:savedRoom.code,ready:isReady});
    };

  // üí¨ ‡πÅ‡∏ä‡∏ó
  const chatInput = document.getElementById("chatInput"),
        sendBtn   = document.getElementById("sendBtn"),
        box       = document.getElementById("chatMessages");

  function addMsg(s,t){
    const p=document.createElement("p");
    p.innerHTML=`<b>${s}:</b> ${t}`;
    box.appendChild(p); box.scrollTop=box.scrollHeight;
  }

  function sendMessage(){
    const msg = chatInput.value.trim();
    // ‚õ≥ ‡∏î‡∏∂‡∏á room ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤/‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
    const roomCode = savedRoom?.code;
    if (!msg) return;

    if (!socket?.connected) {
      addMsg("System","‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå");
      return;
    }
    if (!roomCode) {
      addMsg("System","‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á (room code ‡∏ß‡πà‡∏≤‡∏á)");
      return;
    }
    socket.emit("chatMessage",{ room: roomCode, text: msg });
    chatInput.value="";
  }

  sendBtn.onclick = sendMessage;
  chatInput.addEventListener("keydown",e=>{
    if (e.isComposing) return;
    if (e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }
  });

  // ‚õ≥ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ù‡∏±‡πà‡∏á server ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô null
  socket.on("chatMessage",(data)=> addMsg(data.sender || "Anon", data.text));


    // üë• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô & Auto start
    socket.on("updatePlayers",(playerList)=>{
      const list=document.getElementById("playerList");
      list.innerHTML="";
      playerList.forEach(p=>{
        const li=document.createElement("li");
        li.textContent=`${p.name} ${p.ready?"‚úîÔ∏è":"‚åõ"}`;
        list.appendChild(li);
      });
      const allReady=playerList.every(p=>p.ready);
      if(allReady && playerList.length>1){
        showWarning();
        startCountdown();
      }
    });

    // üîô Back
    document.getElementById("btnBack").onclick=()=>location.href="roomlist.html";
  </script>
</body>
</html>
