<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Room</title>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden;
      font-family: 'Segoe UI', system-ui, sans-serif; color:#E6E6FA; }
    #bgCanvas { position:fixed; inset:0; z-index:-1; }

    .room-container{
      width: 680px; max-width: 92%;
      background: rgba(20,28,48,0.6); backdrop-filter: blur(10px);
      border: 2px solid rgba(100,200,255,.3); border-radius: 20px;
      padding: 32px; box-shadow: 0 0 25px rgba(100,200,255,.2);
      margin: 64px auto; text-align: center; position: relative;
    }
    .title { font-size: 36px; margin: 6px 0 18px; text-shadow: 0 0 10px #ffffff66 }

    .back-btn {
      position:absolute; top:16px; left:16px;
      padding:10px 16px; border-radius:999px; border:0;
      background:#394867; color:#fff; font-weight:800; cursor:pointer;
      box-shadow:0 6px 16px #0007; transition:transform .15s ease;
    }
    .back-btn:hover{ transform: translateY(-2px) }

    label{ display:block; text-align:left; margin:10px 0 6px; font-weight:700 }
    input, select{
      width:100%; padding:12px; border-radius:10px; border:0;
      background:rgba(255,255,255,.12); color:#fff; outline:none; margin-bottom:14px;
    }
    input:focus, select:focus{ background:rgba(255,255,255,.22) }

    .btn{
      width:100%; padding:14px 18px; border:0; border-radius:12px;
      font-weight:900; cursor:pointer; margin-top:12px;
      background: linear-gradient(135deg,#2fe093,#25c07d); color:#0b1324;
      box-shadow:0 8px 24px rgba(47,224,147,.35); transition:transform .15s ease;
    }
    .btn:hover{ transform: translateY(-2px) }

    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.7);
      align-items:center; justify-content:center; z-index:9999; }
    .dialog { background:#1e1e2f; color:#fff; padding:24px; border-radius:16px; width:320px; box-shadow:0 0 20px rgba(0,0,0,.5) }
    .dialog-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px }
    .dialog-body label.row { display:flex; justify-content:space-between; align-items:center; margin:8px 0 }
    .dialog-body input[type=range], .dialog-body select { width:160px }
    .dialog-body .note { margin-top:10px; font-size:.85em; color:#ccc }
    .x { background:none; border:none; color:#fff; font-size:18px; cursor:pointer }

    .icon-btn { position:absolute; top:18px; right:18px; background:rgba(255,255,255,.1);
      border:none; border-radius:50%; width:40px; height:40px; cursor:pointer; color:#fff;
      display:flex; align-items:center; justify-content:center; transition:background .2s }
    .icon-btn:hover { background:rgba(255,255,255,.25) }
    .icon-btn svg { width:22px; height:22px; fill:#fff }

    .modal[aria-hidden="false"]{ display:flex; animation:fadeIn .25s ease }
    @keyframes fadeIn{ from{ opacity:0; transform:scale(.96) } to{ opacity:1; transform:scale(1) } }

    select{ appearance:none; -webkit-appearance:none; -moz-appearance:none; background:#2b2d42; color:#E6E6FA;
      border:1px solid rgba(100,200,255,.3); border-radius:8px; padding:10px 12px }
    select option{ background:#1a1a2e; color:#E6E6FA }
    select option:hover, select option:checked, select option:focus{ background:#25c07d; color:#0b1324 }

    #pageContainer { transition: opacity .25s ease }
    .fade { opacity: 0 }
  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>
  <script src="./common-settings.js" defer></script>

  <main class="room-container" id="setup">
    <button class="back-btn" id="btnBack">‚¨Ö Leave</button>
    <h1 class="title">CREATE ROOM</h1>

    <button class="icon-btn" title="Settings" id="btnSettingsTop" aria-label="Settings">
      <svg viewBox="0 0 24 24"><path d="M12 8a4 4 0 1 1-4 4 4 4 0 0 1 4-4Zm9 4a7.43 7.43 0 0 0-.09-1l2.09-1.64-2-3.46-2.49.63a7.51 7.51 0 0 0-1.73-1L14.5 2h-5l-.28 2.53a7.51 7.51 0 0 0-1.73-1l-2.49-.63-2 3.46L4.09 11a7.43 7.43 0 0 0 0 2l-2.09 1.64 2 3.46 2.49-.63a7.51 7.51 0 0 0 1.73-1L9.5 22h5l.28-2.53a7.51 7.51 0 0 0 1.73-1l2.49.63 2-3.46L20.91 13a7.43 7.43 0 0 0 .09-1Z"/></svg>
    </button>

    <!-- SETTINGS MODAL -->
    <div class="modal" id="settingsModal" aria-hidden="true" role="dialog">
      <div class="dialog">
        <div class="dialog-head">
          <h3>Settings</h3>
          <button class="x" id="closeSettings">‚úñ</button>
        </div>
        <div class="dialog-body">
          <label class="row"><span>Master Volume</span><input id="rangeMaster" type="range" min="0" max="1" step="0.01"></label>
          <label class="row"><span>Music</span><input id="rangeMusic" type="range" min="0" max="1" step="0.01"></label>
          <label class="row"><span>SFX</span><input id="rangeSfx" type="range" min="0" max="1" step="0.01"></label>
          <label class="row">
            <span>Region</span>
            <select id="regionSel">
              <option value="asia">Asia</option>
              <option value="na">North America</option>
              <option value="eu">Europe</option>
            </select>
          </label>
          <div class="note">* ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå (localStorage)</div>
        </div>
      </div>
    </div>

    <label for="roomName">üìõ Room Name</label>
    <input id="roomName" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‚Ä¶">
    <div id="nameError" style="color:#ff6b6b; font-size:14px; margin-top:4px; min-height:18px;"></div>

    <label for="maxPlayers">üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</label>
    <select id="maxPlayers">
      <option value="4">4</option>
      <option value="6">6</option>
      <option value="8" selected>8</option>
      <option value="10">10</option>
    </select>

    <label for="roomType">üîí ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á</label>
    <select id="roomType">
      <option value="public">Public (‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏î‡πâ)</option>
      <option value="private">Private (‡∏•‡πá‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á)</option>
    </select>

    <!-- üîë ‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Private) -->
    <div id="roomPassRow" style="display:none; margin-top:8px">
      <label for="roomPass">üîë Room Password (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß)</label>
      <input id="roomPass" type="password" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á Private">
    </div>

    <button class="btn" id="btnCreate">üöÄ CREATE ROOM</button>
  </main>

  <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á -->
  <script src="./room-bg.js" defer></script>

  <!-- ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á (ESM) -->
  <script type="module">
    import { rtdb, ref, set, update, onDisconnect, get } from "./firebase.js";
    import { serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

    // ----- UI: settings modal -----
    const modal = document.getElementById('settingsModal');
    document.getElementById('btnSettingsTop').onclick = ()=> modal.setAttribute('aria-hidden','false');
    document.getElementById('closeSettings').onclick = ()=> modal.setAttribute('aria-hidden','true');

    // ----- BG -----
    const canvas = document.getElementById("bgCanvas");
    const ctx = canvas.getContext("2d");
    function drawBackground(){
      canvas.width = innerWidth; canvas.height = innerHeight;
      const g = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width*.6);
      g.addColorStop(0,"#1e2130"); g.addColorStop(1,"#0b0d12");
      ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);
      for(let i=0;i<100;i++){
        const x=Math.random()*canvas.width,y=Math.random()*canvas.height;
        ctx.fillStyle=`rgba(255,255,255,${Math.random()*.5+.3})`;
        ctx.beginPath();ctx.arc(x,y,Math.random()*1.5+.5,0,Math.PI*2);ctx.fill();
      }
    }
    drawBackground(); setInterval(drawBackground, 10000);

    // ----- Helpers -----
    const $ = (id)=>document.getElementById(id);
    const nameInput = $("roomName"), nameError = $("nameError");
    $("btnBack").onclick = ()=> location.href = "index.html";

    // ‡πÇ‡∏ä‡∏ß‡πå/‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Private
    const roomTypeSel = $("roomType");
    const passRow = $("roomPassRow");
    roomTypeSel.addEventListener("change", () => {
      passRow.style.display = roomTypeSel.value === "private" ? "block" : "none";
    });

    function genCode(len=4){
      const chars = "ABCDEFGHJKMNPQRSTUVWXYZ23456789";
      let s = ""; for(let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
      return s;
    }
    function getPlayerName(){
      return localStorage.getItem('ggd.name')
          || localStorage.getItem('playerName')
          || `Player_${Math.floor(Math.random()*1000)}`;
    }
    // uid ‡∏ï‡πà‡∏≠‡πÅ‡∏ó‡πá‡∏ö (‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ó‡πá‡∏ö)
    const uid = sessionStorage.getItem('ggd.uid') || (()=>{ 
      const v = (crypto?.randomUUID?.() || ('uid_'+Math.random().toString(36).slice(2,10)));
      sessionStorage.setItem('ggd.uid', v);
      return v;
    })();

    // SHA-256 ‚Üí hex
    async function sha256Hex(s){
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(s));
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    async function createRoom(){
      const roomName = (nameInput.value || "").trim();
      const maxPlayers = parseInt($("maxPlayers").value,10);
      const roomType = $("roomType").value;
      const hostName = getPlayerName();

      if(!roomName){
        nameError.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á";
        nameInput.focus();
        return;
      }
      nameError.textContent = "";

      let joinHash = null;
      if (roomType === "private") {
        const pass = (document.getElementById('roomPass').value || '').trim();
        if (pass.length < 4) {
          alert('‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß');
          document.getElementById('roomPass').focus();
          return;
        }
        joinHash = await sha256Hex(pass);
      }

      // ‡∏™‡∏∏‡πà‡∏° code ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ä‡∏ô
      let code = genCode(4);
      let tries = 0;
      while (tries < 6) {
        const snap = await get(ref(rtdb, `rooms/${code}`));
        if (!snap.exists()) break;
        code = genCode(4);
        tries++;
      }

      // 1) rooms/{code}
      const roomRef = ref(rtdb, `rooms/${code}`);
      await set(roomRef, {
        code, name: roomName, maxPlayers, type: roomType,
        host: hostName, status: "lobby",
        playerCount: 1,
        joinHash: joinHash || null,     // <‚Äî ‡πÄ‡∏Å‡πá‡∏ö hash ‡πÑ‡∏ß‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ï‡∏≠‡∏ô join (private)
        createdAt: serverTimestamp(), lastActivity: serverTimestamp()
      });

      // 2) lobbies/{code}/players/{uid}  (‡πÉ‡∏ä‡πâ uid ‡πÅ‡∏ó‡∏ô‡∏ä‡∏∑‡πà‡∏≠ ‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡∏ö)
      const meRef = ref(rtdb, `lobbies/${code}/players/${uid}`);
      await set(meRef, {
        uid,
        name: hostName, isHost: true, ready: false, online: true,
        char: "mini_brown", joinTime: serverTimestamp()
      });
      onDisconnect(meRef).remove();

      // 3) bump activity
      await update(roomRef, { lastActivity: serverTimestamp() });

      // 4) context ‚Üí ‡πÑ‡∏õ lobby
      localStorage.setItem("currentRoom", JSON.stringify({
        code, name: roomName, maxPlayers, type: roomType, isHost: true
      }));
      localStorage.setItem("playerName", hostName);
      localStorage.setItem("ggd.name", hostName);

      // ‡πÄ‡∏Å‡πá‡∏ö token ‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏≤ ‚Äú‡∏ú‡πà‡∏≤‡∏ô‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß‚Äù (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ lobby ‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à)
      if (roomType === "private") {
        localStorage.setItem(`roomAuth:${code}`, 'ok');
      }

      location.href = `lobby.html?code=${code}`;
    }

    document.getElementById("btnCreate").onclick = ()=> {
      createRoom().catch(err=>{
        console.error(err);
        alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (err.message || err));
      });
    };
    nameInput.addEventListener("keydown", e=>{
      if(e.key==="Enter") document.getElementById("btnCreate").click();
    });
  </script>

  <!-- Dev helper -->
  <script>
    window.addEventListener('error', e => console.warn('Script error:', e.message));
    window.addEventListener('unhandledrejection', e => console.warn('Promise error:', (e.reason?.message || e.reason)));
  </script>
</body>
</html>
