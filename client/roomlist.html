<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Room List</title>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    /* ‚úÖ ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ */
    #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    .bg-video-overlay {
      position: fixed; inset: 0;
      background:
        radial-gradient(60vmax 40vmax at 70% 20%, #6b9cff11, #0000 70%),
        radial-gradient(40vmax 30vmax at 30% 70%, #f6d36511, #0000 70%);
      filter: blur(2px) saturate(140%); z-index: 1; pointer-events: none;
    }
    body {
      font-family: "Segoe UI", sans-serif; color: #e6e6fa;
      display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
      padding-top: 60px; margin: 0; min-height: 100vh; position: relative; z-index: 2;
      background:#0b1324;
    }
    .page-title { font-size: 36px; font-weight: bold; margin-bottom: 20px; text-align: center; text-shadow: 0 2px 10px rgba(0,0,0,0.6); z-index: 2; }
    .lobby-container {
      width: 800px; max-width: 90%;
      background: rgba(27, 38, 59, 0.95);
      border: 2px solid #394867; border-radius: 20px; padding: 30px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
      display: flex; flex-direction: column; position: relative; z-index: 2;
      gap:16px;
    }
    .back-btn {
      position: absolute; top: 20px; left: 20px;
      background: linear-gradient(135deg, #2fe093, #54f4a8); color: #0b1324; border: none;
      padding: 10px 20px; border-radius: 30px; font-weight: bold; font-size: 16px; cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: 0.25s;
    }
    .back-btn:hover { background: linear-gradient(135deg, #25c07d, #3edc90); transform: translateY(-2px); }
    #createRoomBtn {
      align-self: flex-end; margin-bottom: 0; padding: 12px 20px;
      background: #2fe093; border: none; border-radius: 30px; font-weight: bold; font-size: 16px;
      cursor: pointer; color: #0b1324; transition: 0.2s;
    }
    #createRoomBtn:hover { background: #25c07d; }
    #roomListWrapper {
      background: rgba(14, 22, 38, 0.7); border: 1px solid #394867; border-radius: 16px; padding: 16px;
      max-height: 480px; overflow-y: auto;
    }
    #roomList { display: grid; gap: 16px; }
    .room-card {
      background: rgba(14, 22, 38, 0.85); border: 1px solid #394867; border-radius: 14px; padding: 16px 20px;
      display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s, box-shadow 0.2s;
    }
    .room-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.4); }
    .room-info { display: flex; flex-direction: column; gap: 4px; }
    .room-name { font-size: 20px; font-weight: bold; }
    .room-detail { font-size: 14px; opacity: 0.8; }
    .join-btn { padding: 10px 16px; background: #76f7b1; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: #0b1324; transition: 0.2s; }
    .join-btn:hover { background: #54f4a8; }
    .muted{opacity:.8;font-size:13px}
    #info {min-height:18px}
  </style>
</head>
<body>
  <!-- üü¶ ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á -->
  <canvas id="bgCanvas"></canvas>
  <div class="bg-video-overlay"></div>

  <!-- üß© ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å -->
  <div class="page-title">üìú Room List</div>

  <div class="lobby-container">
    <button id="backBtn" class="back-btn" onclick="window.location.href='index.html'">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button>
    <button id="createRoomBtn" onclick="window.location.href='createroom.html'">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>

    <div id="info" class="muted"></div>

    <div id="roomListWrapper">
      <div id="roomList"><!-- ‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ --></div>
      <div id="emptyState" style="opacity:.8; text-align:center; padding:16px; display:none;">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡∏•‡∏≠‡∏á‡∏Å‡∏î ‚Äú‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‚Äù ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
      </div>
    </div>
  </div>

  <!-- ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô module) -->
  <script src="./room-bg.js" defer></script>

  <!-- ‚úÖ ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏î‡∏∂‡∏á‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏´‡πâ‡∏≠‡∏á (‡∏°‡∏µ fallback 3 ‡∏ä‡∏±‡πâ‡∏ô + debug) -->
  <script type="module">
    import { db } from "./firebase.js";
    import { getApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      collection, query, where, orderBy, onSnapshot, getDocs
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const $ = (id) => document.getElementById(id);
    const listEl = $("roomList");
    const emptyEl = $("emptyState");
    const infoEl = $("info");

    // debug: ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ä‡∏µ‡πâ project ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ create
    try { console.log("[roomlist] projectId =", getApp().options.projectId); } catch {}

    const createdCode = new URLSearchParams(location.search).get("code");
    if (createdCode) infoEl.textContent = `‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á: ${createdCode}`;

    // ---------- renderer ----------
    function renderSnapshot(snap){
      listEl.innerHTML = "";
      if (snap.empty) {
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";

      snap.forEach(docSnap => {
        const r = docSnap.data();
        const code = r.code || docSnap.id;
        const card = document.createElement("div");
        card.className = "room-card";
        card.innerHTML = `
          <div class="room-info">
            <div class="room-name">‡∏´‡πâ‡∏≠‡∏á ${r.name}</div>
            <div class="room-detail">
              ${r.type || "public"} ¬∑ host: ${r.host || "-"}
            </div>
          </div>
          <button class="join-btn">Join</button>
        `;
        card.querySelector(".join-btn").onclick = () => location.href = `lobby.html?code=${code}`;
        if (createdCode && code === createdCode) {
          card.style.outline = "2px solid #76f7b1";
          card.style.boxShadow = "0 0 0 3px rgba(118,247,177,.25)";
        }
        listEl.appendChild(card);
      });
    }

    // ---------- Fallback logic ----------
    async function attachRealtimeWithFallback() {
      // Q1: status + createdAt (‡∏™‡∏ß‡∏¢‡∏™‡∏∏‡∏î ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ index)
      try {
        const q1 = query(collection(db, "rooms"),
          where("status","==","lobby"),
          orderBy("createdAt","desc")
        );
        console.log("[roomlist] try Q1 (status==lobby + orderBy createdAt)");
        // ‡∏•‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•‡πÄ‡∏£‡πá‡∏ß)
        const once = await getDocs(q1);
        renderSnapshot(once);
        // ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ subscribe
        onSnapshot(q1, renderSnapshot, onRealtimeError);
        return;
      } catch (e) {
        console.warn("[roomlist] Q1 failed:", e?.code || e);
      }

      // Q2: ‡πÅ‡∏Ñ‡πà orderBy(createdAt) (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ index‡∏£‡πà‡∏ß‡∏°)
      try {
        const q2 = query(collection(db, "rooms"), orderBy("createdAt","desc"));
        console.log("[roomlist] try Q2 (orderBy createdAt)");
        const once = await getDocs(q2);
        renderSnapshot(once);
        onSnapshot(q2, renderSnapshot, onRealtimeError);
        return;
      } catch (e) {
        console.warn("[roomlist] Q2 failed:", e?.code || e);
      }

      // Q3: ‡∏î‡∏∂‡∏á‡∏î‡∏¥‡∏ö‡πÜ (‡πÑ‡∏°‡πà‡∏°‡∏µ where/orderBy) ‚Äî ‡πÄ‡∏´‡πá‡∏ô‡πÅ‡∏ô‡πà
      try {
        const q3 = collection(db, "rooms");
        console.log("[roomlist] try Q3 (raw collection)");
        const once = await getDocs(q3);
        renderSnapshot(once);
        onSnapshot(q3, renderSnapshot, onRealtimeError);
        return;
      } catch (e) {
        console.error("[roomlist] Q3 failed:", e?.code || e);
        listEl.innerHTML = "";
        emptyEl.style.display = "block";
        emptyEl.textContent =
          e?.code === "permission-denied"
            ? "‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: permission-denied (‡πÄ‡∏ä‡πá‡∏Å Firestore rules ‡πÉ‡∏´‡πâ allow read ‡∏ó‡∏µ‡πà /rooms)"
            : "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á (‡∏î‡∏π Console)";
      }
    }

    function onRealtimeError(err){
      console.error("[roomlist] onSnapshot error:", err);
      emptyEl.style.display = "block";
      emptyEl.textContent =
        err?.code === "permission-denied"
          ? "‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: permission-denied (‡πÄ‡∏ä‡πá‡∏Å Firestore rules: allow read ‡∏ó‡∏µ‡πà /rooms)"
          : (err?.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á");
    }

    attachRealtimeWithFallback();
  </script>
</body>
</html>
