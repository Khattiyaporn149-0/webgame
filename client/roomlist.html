<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Room List</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://www.gstatic.com; connect-src 'self' https://*.firebasedatabase.app wss://*.firebasedatabase.app https://www.googleapis.com https://securetoken.googleapis.com https://www.gstatic.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.gstatic.com https://apis.google.com https://*.firebasedatabase.app; img-src 'self' data: blob: https://www.gstatic.com https://*.googleusercontent.com; style-src 'self' 'unsafe-inline'; font-src 'self' data:;">
  <!-- ใช้ styles.css เดียวกับหน้า index เพื่อให้หน้าตาเหมือนกัน -->
  <link rel="stylesheet" href="./styles.css" />

  <style>
    /* BG เฉพาะหน้านี้ */
    #bgCanvas { position: fixed; inset: 0; z-index: 0; }
    .bg-video-overlay {
      position: fixed; inset: 0;
      background:
        radial-gradient(60vmax 40vmax at 70% 20%, #6b9cff11, #0000 70%),
        radial-gradient(40vmax 30vmax at 30% 70%, #f6d36511, #0000 70%);
      filter: blur(2px) saturate(140%);
      z-index: 1; pointer-events: none;
    }

    /* โครงหน้าลิสต์ห้อง (ไม่ไปยุ่งกับ .topbar/.top-icons/.icon-btn ของ styles.css) */
    body {
      font-family: "Segoe UI", sans-serif; color: #e6e6fa;
      display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
      padding-top: 80px; /* ขยับลงเผื่อ topbar */
      margin: 0; min-height: 100vh; position: relative; z-index: 2;
      background:#0b1324;
    }
    .page-title { font-size: 36px; font-weight: bold; margin: 14px 0 20px; text-align: center; text-shadow: 0 2px 10px rgba(0,0,0,0.6); z-index: 2; }
    .lobby-container {
      width: 800px; max-width: 90%;
      background: rgba(27, 38, 59, 0.95);
      border: 2px solid #394867; border-radius: 20px; padding: 30px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
      display: flex; flex-direction: column; position: relative; z-index: 2; gap:16px;
    }
    .back-btn {
      position: absolute; top: 20px; left: 20px;
      background: linear-gradient(135deg, #2fe093, #25c07d); color: #0b1324; border: none;
      padding: 10px 20px; border-radius: 30px; font-weight: bold; font-size: 16px; cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: 0.25s;
    }
    .back-btn:hover { transform: translateY(-2px); }
    #createRoomBtn {
      align-self: flex-end; margin-bottom: 0; padding: 12px 20px;
      background: #2fe093; border: none; border-radius: 30px; font-weight: bold; font-size: 16px;
      cursor: pointer; color: #0b1324; transition: 0.2s;
    }
    #createRoomBtn:hover { background: #25c07d; }

    #roomListWrapper {
      background: rgba(14, 22, 38, 0.7); border: 1px solid #394867; border-radius: 16px; padding: 16px;
      max-height: 480px; overflow-y: auto; position: relative; z-index: 1;
    }
    #roomList { display: grid; gap: 16px; }
    .room-card { background: rgba(14, 22, 38, 0.85); border: 1px solid #394867; border-radius: 14px; padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s, box-shadow 0.2s; }
    .room-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.4); }
    .room-info { display: flex; flex-direction: column; gap: 4px; }
    .room-name { font-size: 20px; font-weight: bold; }
    .room-detail { font-size: 14px; opacity: 0.8; }
    .join-btn { padding: 10px 16px; background: #76f7b1; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: #0b1324; transition: 0.2s; }
    .join-btn:hover { background: #54f4a8; }
    .muted{opacity:.8;font-size:13px}
    #info {min-height:18px}

    .bottom-btn-row{
      position: sticky; bottom: 0; z-index: 5;
      display:flex; justify-content:flex-start; padding-top:16px;
      margin-top:auto; background: rgba(27, 38, 59, 0.95);
      box-shadow: 0 -8px 16px rgba(0,0,0,.2);
    }
    .join-code-btn{ background:#ffda79; color:#0b1324; border:0; border-radius:30px; font-weight:700; cursor:pointer; padding:12px 20px; box-shadow:0 4px 12px rgba(0,0,0,0.3); transition:.2s; }
    .join-code-btn:hover{ background:#fddb5f; transform: translateY(-2px); }

    /* ให้ modal เปิดแน่เมื่อ aria-hidden=false (เผื่อ styles.css ไม่ได้ set ไว้) */
    #settingsModal[aria-hidden="false"],
    #joinModal[aria-hidden="false"] { display:flex !important; }
    /* ปิดค่าเริ่มต้น */
    #settingsModal, #joinModal { display:none; }
  </style>
</head>
<body>
  <!-- BG -->
  <canvas id="bgCanvas"></canvas>
  <div class="bg-video-overlay"></div>

  <!-- TOP BAR (ใช้คลาสเดียวกับ index.html) -->
  <header class="topbar">
    <div class="logo"></div>
    <div class="top-icons">
      <button class="icon-btn" title="Settings" id="btnSettingsTop" aria-label="Settings">
        <svg viewBox="0 0 24 24"><path d="M12 8a4 4 0 1 1-4 4 4 4 0 0 1 4-4Zm9 4a7.43 7.43 0 0 0-.09-1l2.09-1.64-2-3.46-2.49.63a7.51 7.51 0 0 0-1.73-1L14.5 2h-5l-.28 2.53a7.51 7.51 0 0 0-1.73 1l-2.49-.63-2 3.46L4.09 11a7.43 7.43 0 0 0 0 2l-2.09 1.64 2 3.46 2.49-.63a7.51 7.51 0 0 0 1.73-1L9.5 22h5l.28-2.53a7.51 7.51 0 0 0 1.73-1l2.49.63 2-3.46L20.91 13a7.43 7.43 0 0 0 .09-1Z"/></svg>
      </button>
    </div>
  </header>

  <div class="page-title">📜 Room List</div>

  <div class="lobby-container">
    <button class="back-btn" onclick="window.location.href='index.html'">⬅ กลับ</button>
    <button id="createRoomBtn" onclick="window.location.href='createroom.html'">➕ สร้างห้องใหม่</button>

    <div id="info" class="muted"></div>

    <div id="roomListWrapper">
      <div id="roomList"></div>
      <div id="emptyState" style="opacity:.8; text-align:center; padding:16px; display:none;">
        ยังไม่มีห้องในตอนนี้ ลองกด “สร้างห้องใหม่” ด้านบนได้เลย
      </div>
    </div>

    <div class="bottom-btn-row">
      <button id="joinByCodeBtn" type="button" class="join-code-btn" onclick="window._openJoin()">🔑 เข้าด้วยรหัส</button>
    </div>
  </div>

  <!-- SETTINGS MODAL (หน้าตา/ขนาดเหมือนหน้า index) -->
  <div class="modal" id="settingsModal" aria-hidden="true" role="dialog">
    <div class="dialog">
      <div class="dialog-head">
        <h3>Settings</h3>
        <button class="x" id="closeSettings">✖</button>
      </div>
      <div class="dialog-body">
        <label class="row"><span>Master Volume</span><input id="rangeMaster" type="range" min="0" max="1" step="0.01"></label>
        <label class="row"><span>Music</span><input id="rangeMusic" type="range" min="0" max="1" step="0.01"></label>
        <label class="row"><span>SFX</span><input id="rangeSfx" type="range" min="0" max="1" step="0.01"></label>
        <label class="row">
          <span>Region</span>
          <select id="regionSel">
            <option value="asia">Asia</option>
            <option value="na">North America</option>
            <option value="eu">Europe</option>
          </select>
        </label>
        <div class="note">* ค่านี้จะถูกบันทึกลงในเบราว์เซอร์ (localStorage)</div>
      </div>
    </div>
  </div>

  <!-- JOIN-BY-CODE MODAL -->
  <div class="modal" id="joinModal" aria-hidden="true" role="dialog">
    <div class="dialog">
      <div class="dialog-head">
        <h3>เข้าห้องด้วยรหัส</h3>
        <button class="x" id="joinClose">✖</button>
      </div>
      <div class="dialog-body">
        <label class="row" for="joinCodeInput"><span>Room Code</span></label>
        <input id="joinCodeInput" type="text" maxlength="8" placeholder="เช่น ABCD" style="text-transform:uppercase;">
        <div id="joinErr" class="note" style="color:#ff8787;min-height:18px;margin-top:8px"></div>
        <button id="joinSubmit" class="join-btn" style="width:100%;margin-top:8px" type="button">Join</button>
      </div>
    </div>
  </div>

  <!-- โค้ดหลักของหน้า -->
  <script type="module" src="./roomlist.js"></script>

  <!-- สคริปต์ Settings (ใช้ร่วมกับ styles.css ของ index) -->
  <script>
    // เปิด/ปิดโมดอล
    const settingsModal = document.getElementById('settingsModal');
    const btnGear       = document.getElementById('btnSettingsTop');
    const btnCloseSet   = document.getElementById('closeSettings');

    btnGear?.addEventListener('click', ()=> settingsModal?.setAttribute('aria-hidden','false'));
    btnCloseSet?.addEventListener('click', ()=> settingsModal?.setAttribute('aria-hidden','true'));
    settingsModal?.addEventListener('click', (e)=>{ if (e.target === settingsModal) settingsModal.setAttribute('aria-hidden','true'); });

    // โหลด/บันทึกค่า
    const rMaster = document.getElementById('rangeMaster');
    const rMusic  = document.getElementById('rangeMusic');
    const rSfx    = document.getElementById('rangeSfx');
    const selReg  = document.getElementById('regionSel');

    function loadSettings(){
      rMaster.value = localStorage.getItem('set.master') ?? 0.7;
      rMusic.value  = localStorage.getItem('set.music')  ?? 0.6;
      rSfx.value    = localStorage.getItem('set.sfx')    ?? 0.6;
      selReg.value  = localStorage.getItem('set.region') ?? 'asia';
    }
    function bindSave(el, key){ el?.addEventListener('input', ()=> localStorage.setItem(key, el.value)); }

    loadSettings();
    bindSave(rMaster, 'set.master');
    bindSave(rMusic , 'set.music');
    bindSave(rSfx   , 'set.sfx');
    selReg?.addEventListener('change', ()=> localStorage.setItem('set.region', selReg.value));
  </script>
</body>
</html>
