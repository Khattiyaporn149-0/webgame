<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Room List</title>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    /* ‚úÖ ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ */
    #bgCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    .bg-video-overlay {
      position: fixed; inset: 0;
      background:
        radial-gradient(60vmax 40vmax at 70% 20%, #6b9cff11, #0000 70%),
        radial-gradient(40vmax 30vmax at 30% 70%, #f6d36511, #0000 70%);
      filter: blur(2px) saturate(140%); z-index: 1; pointer-events: none;
    }
    body {
      font-family: "Segoe UI", sans-serif; color: #e6e6fa;
      display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
      padding-top: 60px; margin: 0; min-height: 100vh; position: relative; z-index: 2;
      background:#0b1324;
    }
    .page-title { font-size: 36px; font-weight: bold; margin-bottom: 20px; text-align: center; text-shadow: 0 2px 10px rgba(0,0,0,0.6); z-index: 2; }
    .lobby-container {
      width: 800px; max-width: 90%;
      background: rgba(27, 38, 59, 0.95);
      border: 2px solid #394867; border-radius: 20px; padding: 30px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
      display: flex; flex-direction: column; position: relative; z-index: 2;
      gap:16px;
    }
    .back-btn {
      position: absolute; top: 20px; left: 20px;
      background: linear-gradient(135deg, #2fe093, #54f4a8); color: #0b1324; border: none;
      padding: 10px 20px; border-radius: 30px; font-weight: bold; font-size: 16px; cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: 0.25s;
    }
    .back-btn:hover { background: linear-gradient(135deg, #25c07d, #3edc90); transform: translateY(-2px); }
    #createRoomBtn {
      align-self: flex-end; margin-bottom: 0; padding: 12px 20px;
      background: #2fe093; border: none; border-radius: 30px; font-weight: bold; font-size: 16px;
      cursor: pointer; color: #0b1324; transition: 0.2s;
    }
    #createRoomBtn:hover { background: #25c07d; }
    #roomListWrapper {
      background: rgba(14, 22, 38, 0.7); border: 1px solid #394867; border-radius: 16px; padding: 16px;
      max-height: 480px; overflow-y: auto;
    }
    #roomList { display: grid; gap: 16px; }
    .room-card {
      background: rgba(14, 22, 38, 0.85); border: 1px solid #394867; border-radius: 14px; padding: 16px 20px;
      display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s, box-shadow 0.2s;
    }
    .room-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.4); }
    .room-info { display: flex; flex-direction: column; gap: 4px; }
    .room-name { font-size: 20px; font-weight: bold; }
    .room-detail { font-size: 14px; opacity: 0.8; }
    .join-btn { padding: 10px 16px; background: #76f7b1; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: #0b1324; transition: 0.2s; }
    .join-btn:hover { background: #54f4a8; }
    .muted{opacity:.8;font-size:13px}
    #info {min-height:18px}

    /* SETTINGS MODAL */
    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.7);
      align-items:center; justify-content:center; z-index:9999; }
    .dialog{ background:#1e1e2f; color:#fff; padding:24px; border-radius:16px; width:320px; box-shadow:0 0 20px rgba(0,0,0,.5) }
    .dialog-head{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px }
    .dialog-body label.row{ display:flex; justify-content:space-between; align-items:center; margin:8px 0 }
    .dialog-body input[type=range], .dialog-body select{ width:160px }
    .dialog-body .note{ margin-top:10px; font-size:.85em; color:#ccc }
    .x{ background:none; border:none; color:#fff; font-size:18px; cursor:pointer }

    .icon-btn{ position:absolute; top:18px; right:18px; background:rgba(255,255,255,.1);
      border:none; border-radius:50%; width:40px; height:40px; cursor:pointer; color:#fff;
      display:flex; align-items:center; justify-content:center; transition:background .2s }
    .icon-btn:hover{ background:rgba(255,255,255,.25) }
    .icon-btn svg{ width:22px; height:22px; fill:#fff }

    .modal[aria-hidden="false"]{ display:flex; animation:fadeIn .25s ease }
    @keyframes fadeIn{ from{ opacity:0; transform:scale(.96) } to{ opacity:1; transform:scale(1) } }

    #pageContainer { transition: opacity .25s ease }
    .fade { opacity: 0 }
  </style>
</head>
<body>
  <!-- üü¶ ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á -->
  <canvas id="bgCanvas"></canvas>
  <div class="bg-video-overlay"></div>
  <script src="./common-settings.js" defer></script>

  <!-- üß© ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å -->
  <div class="page-title">üìú Room List</div>

  <button class="icon-btn" title="Settings" id="btnSettingsTop" aria-label="Settings">
    <svg viewBox="0 0 24 24"><path d="M12 8a4 4 0 1 1-4 4 4 4 0 0 1 4-4Zm9 4a7.43 7.43 0 0 0-.09-1l2.09-1.64-2-3.46-2.49.63a7.51 7.51 0 0 0-1.73-1L14.5 2h-5l-.28 2.53a7.51 7.51 0 0 0-1.73-1l-2.49-.63-2 3.46L4.09 11a7.43 7.43 0 0 0 0 2l-2.09 1.64 2 3.46 2.49-.63a7.51 7.51 0 0 0 1.73 1L9.5 22h5l.28-2.53a7.51 7.51 0 0 0 1.73-1l2.49.63 2-3.46L20.91 13a7.43 7.43 0 0 0 .09-1Z"/></svg>
  </button>

  <!-- SETTINGS MODAL -->
  <div class="modal" id="settingsModal" aria-hidden="true" role="dialog">
    <div class="dialog">
      <div class="dialog-head">
        <h3>Settings</h3>
        <button class="x" id="closeSettings">‚úñ</button>
      </div>
      <div class="dialog-body">
        <label class="row"><span>Master Volume</span><input id="rangeMaster" type="range" min="0" max="1" step="0.01"></label>
        <label class="row"><span>Music</span><input id="rangeMusic" type="range" min="0" max="1" step="0.01"></label>
        <label class="row"><span>SFX</span><input id="rangeSfx" type="range" min="0" max="1" step="0.01"></label>
        <label class="row">
          <span>Region</span>
          <select id="regionSel">
            <option value="asia">Asia</option>
            <option value="na">North America</option>
            <option value="eu">Europe</option>
          </select>
        </label>
        <div class="note">* ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå (localStorage)</div>
      </div>
    </div>
  </div>

  <div class="lobby-container">
    <button id="backBtn" class="back-btn" onclick="window.location.href='index.html'">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button>
    <button id="createRoomBtn" onclick="window.location.href='createroom.html'">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>

    <div id="info" class="muted"></div>

    <div id="roomListWrapper">
      <div id="roomList"><!-- ‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ --></div>
      <div id="emptyState" style="opacity:.8; text-align:center; padding:16px; display:none;">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡∏•‡∏≠‡∏á‡∏Å‡∏î ‚Äú‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‚Äù ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
      </div>
    </div>
  </div>

  <!-- BG animation -->
  <script src="./room-bg.js" defer></script>

  <!-- ‚úÖ ROOM LIST: RTDB only (‡∏£‡∏ß‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) -->
  <script type="module">
    import { rtdb, ref, onValue, get } from "./firebase.js";

    // --------- Settings modal (‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î) ----------
    const modal = document.getElementById('settingsModal');
    document.getElementById('btnSettingsTop').onclick = ()=> modal.setAttribute('aria-hidden','false');
    document.getElementById('closeSettings').onclick  = ()=> modal.setAttribute('aria-hidden','true');

    // --------- BG canvas ----------
    const canvas = document.getElementById("bgCanvas");
    const ctx = canvas.getContext("2d");
    function drawBackground(){
      canvas.width = innerWidth; canvas.height = innerHeight;
      const g = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, canvas.width*.6);
      g.addColorStop(0,"#1e2130"); g.addColorStop(1,"#0b0d12");
      ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);
      for(let i=0;i<100;i++){
        const x=Math.random()*canvas.width,y=Math.random()*canvas.height;
        ctx.fillStyle=`rgba(255,255,255,${Math.random()*.5+.3})`;
        ctx.beginPath();ctx.arc(x,y,Math.random()*1.5+.5,0,Math.PI*2);ctx.fill();
      }
    }
    drawBackground(); setInterval(drawBackground,10000);

    // --------- Helpers ----------
    const $ = (id)=>document.getElementById(id);
    const listEl = $("roomList");
    const emptyEl = $("emptyState");
    const infoEl = $("info");

    const playerName =
      localStorage.getItem("ggd.name") ||
      localStorage.getItem("playerName") ||
      `Player_${Math.random().toString(36).slice(2,7)}`;

    const createdCode = new URLSearchParams(location.search).get("code");
    if (createdCode) infoEl.textContent = `‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á: ${createdCode}`;

    function renderRooms(roomsObj){
      const rooms = Object.values(roomsObj||{})
        .filter(r => (r.type??"public")==="public" && (r.status??"lobby")==="lobby")
        .sort((a,b)=>(b.lastActivity||0)-(a.lastActivity||0));

      listEl.innerHTML = "";
      if(!rooms.length){ emptyEl.style.display="block"; return; }
      emptyEl.style.display="none";

      rooms.forEach(r=>{
        const div = document.createElement("div");
        div.className = "room-card";
        div.innerHTML = `
          <div class="room-info">
            <div class="room-name">${r.name || "(no name)"} </div>
            <div class="room-detail">üë• ${r.playerCount || 0}/${r.maxPlayers ?? "?"} ‚Ä¢ üîí ${r.type || "-"}</div>
          </div>
          <button class="join-btn" data-code="${r.code}">Join</button>
        `;
        div.querySelector(".join-btn").onclick = async (e)=>{
          const code = e.currentTarget.dataset.code;
          const snap = await get(ref(rtdb, `rooms/${code}`));
          const room = snap.val();
          if(!room || room.status!=="lobby"){ alert("‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß"); return; }
          if(room.playerCount >= (room.maxPlayers || 999)){ alert("‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß"); return; }

          // ‡πÄ‡∏ã‡∏ü context ‚Üí lobby
          localStorage.setItem("currentRoom", JSON.stringify({
            code: room.code, name: room.name, maxPlayers: room.maxPlayers,
            type: room.type, isHost: false
          }));
          if(!localStorage.getItem("playerName")) localStorage.setItem("playerName", playerName);
          if(!localStorage.getItem("ggd.name"))   localStorage.setItem("ggd.name", playerName);

          location.href = `lobby.html?code=${code}`;
        };

        if(createdCode && r.code===createdCode){
          div.style.outline = "2px solid #76f7b1";
          div.style.boxShadow = "0 0 0 3px rgba(118,247,177,.25)";
        }
        listEl.appendChild(div);
      });
    }

    // --------- subscribe realtime ‡∏à‡∏≤‡∏Å RTDB ----------
    onValue(ref(rtdb,"rooms"), snap => renderRooms(snap.val()), err=>{
      console.error("[roomlist] onValue error:", err);
      emptyEl.style.display="block";
      emptyEl.textContent = "‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏ï‡∏£‡∏ß‡∏à RTDB rules)";
    });
  </script>
</body>
</html>
